name: CI â€“ Build Â· Lint Â· Sonar

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-test-analyse:
    runs-on: ubuntu-latest

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1â”‚  Expose repository secrets as environment variables
    #    (all values are masked in the log)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    env:
      # Dwolla
      DWOLLA_API_KEY:       ${{ secrets.DWOLLA_API_KEY }}
      DWOLLA_API_SECRET:    ${{ secrets.DWOLLA_API_SECRET }}
      DWOLLA_ENVIRONMENT:   ${{ secrets.DWOLLA_ENVIRONMENT }}  # keep ONE canonical name
      DWOLLA_ENV:           ${{ secrets.DWOLLA_ENVIRONMENT }}  # â† legacy alias (safe to drop if unused)
      DWOLLA_BASE_URL:      ${{ secrets.DWOLLA_BASE_URL }}

      # Plaid (optional â€” remove if not used)
      PLAID_CLIENT_ID:      ${{ secrets.PLAID_CLIENT_ID }}
      PLAID_SECRET:         ${{ secrets.PLAID_SECRET }}
      PLAID_PRODUCTS:       ${{ secrets.PLAID_PRODUCTS }}
      PLAID_ENV:           ${{ secrets.PLAID_ENV }}

      # SonarCloud
      SONAR_TOKEN:          ${{ secrets.SONAR_TOKEN }}

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥  Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§  Set up Node 18 (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: ğŸ“¦  Install dependencies
        run: npm ci

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2â”‚  Create a *temporary* .env file for tools that insist on it
      #    It is deleted before the Sonar scan, so secrets never reach
      #    the analyser or end up as artefacts.
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”‘  Create throw-away .env.ci
        run: |
          cat <<EOF > .env.ci
          DWOLLA_API_KEY=$DWOLLA_API_KEY
          DWOLLA_API_SECRET=$DWOLLA_API_SECRET
          DWOLLA_ENVIRONMENT=$DWOLLA_ENVIRONMENT
          DWOLLA_BASE_URL=$DWOLLA_BASE_URL
          PLAID_CLIENT_ID=$PLAID_CLIENT_ID
          PLAID_SECRET=$PLAID_SECRET
          PLAID_PRODUCTS=$PLAID_PRODUCTS
          PLAID_ENV=$PLAID_ENV
          EOF

      - name: ğŸ§¹  Lint
        run: npm run lint

      - name: ğŸ› ï¸  Build
        run: npm run build

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3â”‚  Remove the temp file so Sonar never scans live secrets
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ—‘ï¸  Delete temp .env
        run: rm .env.ci

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4â”‚  SonarCloud static-code & secret-detection scan
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”  SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          args: >
            -Dsonar.projectVersion=${{ github.sha }}
            -Dsonar.login=$SONAR_TOKEN
